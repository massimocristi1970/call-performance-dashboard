<script>
/* -------------------- Data sources -------------------- */
const dataSources = {
  "inbound-calls":"shared-data/inbound_calls.csv",
  "outbound-calls":"shared-data/outbound_calls.csv",
  "first-contact-resolution":"shared-data/first_contact_resolution.csv"
};

const reportData = {};
const charts = {};

/* -------------------- Helpers -------------------- */
function normalizeHeader(h){
  return String(h||'').trim().toLowerCase().replace(/\s+/g,'');
}

function cleanNumber(v){
  if (v == null) return 0;
  let s = String(v).trim().replace(/\u00A0/g,'').replace(/Â/g,'');
  if (!s) return 0;
  let neg = false;
  if (/^\(.*\)$/.test(s)) { neg = true; s = s.slice(1,-1).trim(); }
  if (/^\d{1,3}(\.\d{3})+,\d{2}$/.test(s)) {
    s = s.replace(/\./g,'').replace(',', '.');
  } else {
    s = s.replace(/[£€$,]/g,'');
  }
  const n = parseFloat(s);
  return Number.isFinite(n) ? (neg ? -n : n) : 0;
}

function fmtNumber(n){ return cleanNumber(n).toLocaleString(); }
function fmtMoney(n){ return "£"+(cleanNumber(n)).toLocaleString(undefined,{maximumFractionDigits:2}); }
function sum(rows,key){ return rows.reduce((a,r)=>a+cleanNumber(r[key]),0); }
function avg(rows,key){ const vals=rows.map(r=>cleanNumber(r[key])).filter(v=>v>0); return vals.length? vals.reduce((a,b)=>a+b,0)/vals.length : 0; }

/* -------------------- CSV Parser -------------------- */
function parseCSV(text){
  const lines = String(text||'').replace(/^\uFEFF/,'').split(/\r?\n/);
  const rows = lines.filter((l,i)=> i===0 || l.trim() !== '');
  if (!rows.length) return [];
  const head = rows[0];
  const count = (s)=>{let c=0,inQ=false;for(let i=0;i<head.length;i++){const ch=head[i];if(ch==='"') inQ=!inQ; else if(!inQ&&ch===s)c++;}return c;};
  const delim = (count('\t')>count(',')&&count('\t')>count(';'))?'\t':(count(';')>count(',')?';':',');

  const splitRow=(row)=>{const out=[];let cur='',inQ=false;
    for(let i=0;i<row.length;i++){
      const ch=row[i];
      if(ch==='"'){ if(inQ && row[i+1]==='"'){cur+='"';i++;} else inQ=!inQ; }
      else if(ch===delim && !inQ){ out.push(cur); cur=''; }
      else { cur+=ch; }
    }
    out.push(cur); return out;
  };

  const headers = splitRow(rows[0]).map(normalizeHeader);
  const data = [];
  for(let i=1;i<rows.length;i++){
    const parts = splitRow(rows[i]);
    if(!parts.length) continue;
    const rec={};
    headers.forEach((h,idx)=> rec[h]=(parts[idx]??'').trim().replace(/\uFFFD/g,''));
    if(Object.values(rec).some(v=>String(v).trim()!=='')) data.push(rec);
  }
  return data;
}

/* -------------------- Tables -------------------- */
function renderTable(rows,maxRows=50){
  if(!rows.length)return '';
  const headers=Object.keys(rows[0]);
  const head=`<thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>`;
  const body=`<tbody>${rows.slice(0,maxRows).map(r=>`<tr>${headers.map(h=>`<td>${r[h]??''}</td>`).join('')}</tr>`).join('')}</tbody>`;
  return `<div class="table-wrap"><table>${head}${body}</table></div>`;
}

/* -------------------- Renderers -------------------- */
function renderInboundReport(){
  const report='inbound-calls';
  const target=document.getElementById(`${report}-content`);
  const rows=reportData[report]||[];
  if(!rows.length){ target.innerHTML = `<div class="panel">No inbound calls data.</div>`; return; }

  const total=sum(rows,'count');
  const avgHandle=avg(rows,'handletime');

  const kpiHTML = `
    <div class="panel"><div class="kpis">
      <div class="kpi"><div class="label">Total Calls</div><div class="value">${fmtNumber(total)}</div></div>
      <div class="kpi"><div class="label">Avg Handle Time</div><div class="value">${avgHandle.toFixed(1)} mins</div></div>
    </div></div>
  `;

  target.innerHTML = kpiHTML + `<div class="panel">${renderTable(rows)}</div>`;
}

function renderOutboundReport(){
  const report='outbound-calls';
  const target=document.getElementById(`${report}-content`);
  const rows=reportData[report]||[];
  if(!rows.length){ target.innerHTML = `<div class="panel">No outbound calls data.</div>`; return; }

  const total=sum(rows,'count');
  const avgDur=avg(rows,'duration');

  const kpiHTML = `
    <div class="panel"><div class="kpis">
      <div class="kpi"><div class="label">Total Calls</div><div class="value">${fmtNumber(total)}</div></div>
      <div class="kpi"><div class="label">Avg Duration</div><div class="value">${avgDur.toFixed(1)} mins</div></div>
    </div></div>
  `;

  target.innerHTML = kpiHTML + `<div class="panel">${renderTable(rows)}</div>`;
}

function renderFCRReport(){
  const report='first-contact-resolution';
  const target=document.getElementById(`${report}-content`);
  const rows=reportData[report]||[];
  if(!rows.length){ target.innerHTML = `<div class="panel">No FCR data.</div>`; return; }

  const total=rows.length;
  const resolved = rows.filter(r=>String(r['resolved']).toLowerCase()==='yes').length;
  const fcrRate = total ? (resolved/total*100) : 0;

  const kpiHTML = `
    <div class="panel"><div class="kpis">
      <div class="kpi"><div class="label">Total Cases</div><div class="value">${fmtNumber(total)}</div></div>
      <div class="kpi"><div class="label">Resolved First Contact</div><div class="value">${fmtNumber(resolved)}</div></div>
      <div class="kpi"><div class="label">FCR Rate</div><div class="value">${fcrRate.toFixed(1)}%</div></div>
    </div></div>
  `;

  target.innerHTML = kpiHTML + `<div class="panel">${renderTable(rows)}</div>`;
}

/* -------------------- Navigation -------------------- */
document.querySelectorAll('.nav-link').forEach(link=>{
  link.addEventListener('click',e=>{
    e.preventDefault();
    const page=link.dataset.page;
    document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
    link.classList.add('active');
    document.querySelectorAll('main .page').forEach(p=>p.classList.add('hidden'));
    document.getElementById(`${page}-page`).classList.remove('hidden');

    if(page==='inbound-calls'){ renderInboundReport(); }
    else if(page==='outbound-calls'){ renderOutboundReport(); }
    else if(page==='first-contact-resolution'){ renderFCRReport(); }
  });
});

/* -------------------- Load all data -------------------- */
async function loadAll(){
  for(const [rep,url] of Object.entries(dataSources)){
    try{
      const res = await fetch(url);
      const txt = await res.text();
      reportData[rep] = parseCSV(txt);
      console.log(`Loaded ${reportData[rep].length} rows for ${rep}`);
    }catch(err){
      console.error('Load error', rep, err);
      reportData[rep] = [];
    }
  }
}

document.addEventListener('DOMContentLoaded', async ()=>{
  await loadAll();
  const first=document.querySelector('.nav-link[data-page="inbound-calls"]');
  if(first) first.click();
});
</script>
